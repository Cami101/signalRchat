<html>

<head>
    <title>Serverless Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script>
        window.apiBaseUrl = window.location.origin;
    </script>
    <style>
        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 1s ease;
        }

        .slide-fade-enter,
        .slide-fade-leave-to {
            height: 0px;
            overflow-y: hidden;
            opacity: 0;
        }
    </style>
</head>

<body>
    <p>&nbsp;</p>
    <div id="app" class="container">
        <h3>Serverless chat</h3>
        <div class="row" v-if="ready">
            <div class="signalr-demo col-sm">
                <hr />
                <div id='groupchecked'>
                    <input type="checkbox" id="checkbox" v-model="checked">
                    <label for="checkbox">Send To Default Group: {{ this.defaultgroup }}</label>
                </div>
                <form v-on:submit.prevent="sendNewMessage(checked)">
                    <input type="text" v-model="newMessage" id="message-box" class="form-control"
                        placeholder="Type message here..." />
                </form>
                <button class="btn btn-primary" v-on:click="createNewChatRoom">Create New Chatroom</button>
            </div>
        </div>
        <div class="row" v-if="!ready">
            <div class="col-sm">
                <div>Loading...</div>
            </div>
        </div>
        <div v-if="ready">
            <h6>Current Group:</h6>
            <div>{{ data.currentgroup }}</div> <!-- Displaying the current group -->
            <h6>Available room:</h6>
            <transition-group name="slide-fade" tag="div">
                <div class="roomrow" v-for="room in chatRooms" v-bind:key="room.id">
                    <a href="#" v-on:click.prevent="switchGroup(data.myConnectionId, room.Text || room.text)">
                        {{ room.Text || room.text }}
                    </a>
                </div>                
                <div class="row" v-for="message in messages" v-bind:key="message.id">
                    <div class="col-sm">
                        <hr />
                        <div>
                            <div style="display: inline-block; padding-left: 12px;">
                                <div>
                                    <a href="#" v-on:click.prevent="sendPrivateMessage(message.Sender)">
                                        <span class="text-info small">
                                            <strong>{{ message.Sender || message.sender }}</strong>
                                        </span>
                                    </a>
                                    <span v-if="message.ConnectionId || message.connectionId">
                                        <a href="#"
                                            v-on:click.prevent="sendToConnection(message.ConnectionId || message.connectionId)">
                                            <span class="badge badge-primary">Connection: {{ message.ConnectionId ||
                                                message.connectionId }}</span>
                                        </a>
                                    </span>
                                    <a href="#" v-on:click.prevent="addUserToGroup(message.Sender || message.sender)">
                                        <span v-if="message.Sender || message.sender"
                                            class="badge badge-primary">AddUserToGroup</span>
                                    </a>
                                    <a href="#"
                                        v-on:click.prevent="removeUserFromGroup(message.Sender || message.sender)">
                                        <span v-if="message.Sender || message.sender"
                                            class="badge badge-primary">RemoveUserFromGroup</span>
                                    </a>
                                    <a href="#"
                                        v-on:click.prevent="addConnectionToGroup(message.ConnectionId || message.connectionId)">
                                        <span v-if="message.ConnectionId || message.connectionId"
                                            class="badge badge-primary">AddConnectionToGroup</span>
                                    </a>
                                    <a href="#"
                                        v-on:click.prevent="removeConnectionIdFromGroup(message.ConnectionId || message.connectionId)">
                                        <span v-if="message.ConnectionId || message.connectionId"
                                            class="badge badge-primary">RemoveConnectionFromGroup</span>
                                    </a>
                                    <span v-if="message.IsPrivate || message.isPrivate" class="badge badge-secondary">
                                        private message
                                    </span>
                                </div>
                                <div>
                                    {{ message.Text || message.text }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition-group>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.3/dist/browser/signalr.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.1.9-1/crypto-js.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/crypto-js@3.1.9-1/enc-base64.js"></script>
        <script>
            const data = {
                username: '',
                defaultgroup: 'AzureSignalR',
                checked: false,
                newMessage: '',
                messages: [],
                chatRooms: [],
                currentgroup: '',
                myConnectionId: '',
                ready: false
            };
            const app = new Vue({
                el: '#app',
                data: data,
                methods: {
                    createNewChatRoom: function () {
                        const newChatRoomName = prompt("Enter a new chatroom name:");
                        if (newChatRoomName) {
                            console.log("createNewChatRoom", newChatRoomName);
                            connection.invoke("createChatRoom", newChatRoomName);
                        }
                    },
                    sendNewMessage: function (isToGroup) {
                        console.log(`sendNewMessage, isToGroup: ${isToGroup}`);
                        console.log("sendNewMessage", this.newMessage);
                        connection.invoke("postmessage", this.newMessage, this.currentgroup);
                        this.newMessage = '';
                    },
                    sendPrivateMessage: function (user) {
                        const messageText = prompt('Send private message to ' + user);

                        if (messageText) {
                            connection.invoke("sendToUser", user, messageText);
                        }
                    },
                    sendToConnection: function (connectionId) {
                        const messageText = prompt('Send private message to connection ' + connectionId);

                        if (messageText) {
                            connection.invoke("sendToConnection", connectionId, messageText);
                        }
                    },
                    switchGroup: function (connectionId, group) {
                        confirm('Switching connection ' + connectionId + ' to group: ' + group);
                        connection.invoke("LeaveGroup", connectionId, this.currentgroup);
                        connection.invoke("joinGroup", connectionId, group);
                        this.messages = [];
                        this.currentgroup = group;
                        connection.invoke("GetAllRoomMessages", group);
                    },
                    // addConnectionIDToGroup: function (connectionId, group) {
                    //     confirm('Add connection ' + connectionId + ' to group: ' + group);
                    //     connection.invoke("JoinGroup", connectionId, group);
                    // },
                    addUserToGroup: function (user) {
                        r = confirm('Add user ' + user + ' to group: ' + this.defaultgroup);
                        connection.invoke("joinUserToGroup", user, this.defaultgroup);
                    },
                    removeConnectionIdFromGroup: function (connectionId) {
                        confirm('Remove connection ' + connectionId + ' from group: ' + this.defaultgroup);
                        connection.invoke("leaveGroup", connectionId, this.defaultgroup);
                    },
                    removeUserFromGroup: function (user) {
                        confirm('Remove user ' + user + ' from group: ' + this.defaultgroup);
                        connection.invoke("leaveUserFromGroup", user, this.defaultgroup);
                    }
                }
            });
            const apiBaseUrl = window.location.origin;
            data.username = prompt("Enter your username");

            var connection = null;
            if (!data.username) {
                alert("No username entered. Reload page and try again.");
                throw "No username entered";
            }
            getConnectionInfo().then(info => {
                
                // make compatible with old and new SignalRConnectionInfo
                // info.accessToken = info.AccessToken || info.accessKey; // pay attention to the case
                // console.log(`getConnectionInfo(), promise, info.url: ${info.url}`);
                // info.url = info.Url || info.endpoint; // pay attention to the case
                data.ready = true;
                console.log("getConnectionInfo(), info:", info);
                const options = {
                    accessTokenFactory: () => info.accessToken
                };
                // var apiBaseUrl = window.location.origin;
                // console.log(`getConnectionInfo(), promise, apiBaseUrl: ${apiBaseUrl}`);
                console.log("getConnectionInfo(), promise, info.url:", info.url);
                console.log("getConnectionInfo(), promise, options", options);
                // console.log(`getConnectionInfo(), promise, info.Url: ${info.Url}`);
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(info.url, options)
                    .configureLogging(signalR.LogLevel.Information)
                    .build();
                console.log(`getConnectionInfo(), promise, connection: ${connection}`);
                connection.on('newMessage', onNewMessage);
                connection.on('newConnection', onNewConnection)
                connection.on('newRoom', onNewRoom)
                connection.onclose(() => console.log('disconnected'));
                console.log('connecting...');
                connection.start().then(() => {
                    data.ready = true;
                    data.currentgroup = "DEFAULT"
                    console.log(`${data.username}connected!`);
                    //connection.invoke("JoinGroup", data.myConnectionId, data.currentgroup);

                }).catch(console.error);
                console.log('connecting to default groom...');
            }).catch(alert);

            function getConnectionInfo() {
                console.log(`getConnectionInfo, url: ${apiBaseUrl}/api/negotiate?userid=${data.username}`);
                return axios.post(`${apiBaseUrl}/api/negotiate?userid=${data.username}`, null, null)
                    .then(resp => resp.data);
            }
            let counter = 0;
            function onNewMessage(messages) {
                console.log("onNewMessage: called, message:", messages);
                messages.forEach(message => {
                    message.id = counter++; // vue transitions need an id
                });
                data.messages.unshift(...messages);
            };
            function onNewRoom(rooms) {
                console.log("onNewRoom: called, rooms:", rooms);
                rooms.forEach(room => {
                    room.id = counter++; // Assign a unique ID for Vue transitions
                });
                data.chatRooms.unshift(...rooms);
            }
            function onNewConnection(message) {
                if (data.myConnectionId == ''){
                    data.myConnectionId = message.ConnectionId;
                }
                console.log("connectionId here:", data.myConnectionId );
                authEnabled = false;
                if (message.Authentication) {
                    authEnabled = true;
                }
                newConnectionMessage = {
                    id: counter++,
                    text: `${message.ConnectionId} has connected`
                };
                data.messages.unshift(newConnectionMessage);
                console.log("connectionId:", message.ConnectionId);
            }

            function base64url(source) {
                // Encode in classical base64
                encodedSource = CryptoJS.enc.Base64.stringify(source);

                // Remove padding equal characters
                encodedSource = encodedSource.replace(/=+$/, '');

                // Replace characters according to base64url specifications
                encodedSource = encodedSource.replace(/\+/g, '-');
                encodedSource = encodedSource.replace(/\//g, '_');

                return encodedSource;
            }
        </script>
</body>

</html>